<html>
  <head>
    <script type='text/javascript' src='https://knockoutjs.com/downloads/knockout-3.5.1.debug.js'></script>
  </head>
  <body>
      <input type="text" id="fqdn" data-bind="value: fqdn" />
      <input type="text" id="hostname" data-bind="value: hostname" />
      <input type="text" id="affected_user" data-bind="value: affected_user" />
      <h2>root abilities</h2>
      <button type="button" data-bind="click: permissions" data-type="root_perms" data-arg="grantall">grant root abilities (mkpool/rmpool/spawnpool)</button>
      <button type="button" data-bind="click: permissions" data-type="root_perms" data-arg="revokeall">revoke root abilities</button>
      <hr>
      <input type="text" id="workerpool" data-bind="value: workerpool" />
      <button type="button" data-bind="click: permissions" data-type="root_cmd" data-arg="mkpool">mkpool</button>
      <button type="button" data-bind="click: permissions" data-type="root_cmd" data-arg="rmpool">rmpool</button>
      <button type="button" data-bind="click: permissions" data-type="root_cmd" data-arg="spawnpool">spawnpool</button>
      <hr>
       <h2>pool abilities</h2>
       <button type="button" data-bind="click: permissions" data-type="pool_perms" data-arg="grantall">grant pool abilities: create/delete</button>
       <button type="button" data-bind="click: permissions" data-type="pool_perms" data-arg="revokeall">revoke pool abilities</button>
       <br>
       <br>
       <input type="text" id="server_name" data-bind="value: server_name" />
       <button type="button" data-bind="click: permissions" data-type="pool_cmd" data-arg="create">create server</button>
       <button type="button" data-bind="click: permissions" data-type="pool_cmd" data-arg="delete">delete server</button>
       <hr>
       <h2>server abilities</h2>
       <button type="button" data-bind="click: permissions" data-type="server_perms" data-arg="grantall">grant server abilities: start/stop/etc</button>
       <button type="button" data-bind="click: permissions" data-type="server_perms" data-arg="revokeall">revoke server abilities</button>
       <br>
       <br>
       <button type="button" data-bind="enable: has_permission('modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "java_xmx", "value": 512}'>xmx</button>
       <button type="button" data-bind="enable: has_permission('modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "java_xms", "value": 512}'>xms</button>
       <button type="button" data-bind="enable: has_permission('modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "jarfile", "value": "minecraft_server.1.8.9.jar"}'>jarfile</button>
       <button type="button" data-bind="enable: has_permission('accept_eula'), click: permissions" data-type="server_cmd" data-arg="accept_eula">eula</button>
       <button type="button" data-bind="enable: has_permission('receive_profile'), click: permissions" data-type="server_cmd" data-arg="receive_profile" data-supplement='{"group": "mojang", "version": "1.8.9"}'>receive</button>
       <br>
       <br>
       <button type="button" data-bind="enable: has_permission('start'), click: permissions" data-type="server_cmd" data-arg="start">start</button>
       <button type="button" data-bind="enable: has_permission('stop'), click: permissions" data-type="server_cmd" data-arg="stop">stop</button>
       <button type="button" data-bind="enable: has_permission('kill'), click: permissions" data-type="server_cmd" data-arg="kill">kill</button>
       <br><br>
       <button type="button" data-bind="enable: has_permission('create'), click: permissions" data-type="server_cmd" data-arg="create" data-supplement='{"alt_cmd": "create"'>create server</button>
       <button type="button" data-bind="enable: has_permission('delete'), click: permissions" data-type="server_cmd" data-arg="delete" data-supplement='{"alt_cmd": "delete"'>delete server</button>
       <hr>
    <ol data-bind="foreach: server_console">
      <li data-bind="text: $data"></li>
    </ol>
  </body>

  <script type="text/javascript">


/* prototypes */

    String.prototype.format = String.prototype.f = function() {
      var s = this,
          i = arguments.length;
    
      while (i--) { s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);}
      return s;
    };

    var webs = null;

    function AppViewModel() {
        this.whoami = ko.observable('plain:will');
        this.perms = ko.observable();
        this.hostname = ko.observable('ruby-worker');
        this.affected_user = ko.observable('plain:will');
        this.workerpool = ko.observable('_throwaway-500');
        this.server_name = ko.observable('test500');
        this.server_console = ko.observableArray();

        this.fqdn = ko.computed(function(){
          return "{0}.{1}.{2}".format(this.hostname(), this.workerpool(), this.server_name());
        }, this);

        this.has_permission = function(thing) {
          var p = this.perms();
          if (p) {
            var pp = p[this.fqdn()]['permissions'];
            if (thing in pp)
              return pp[thing].indexOf(this.whoami()) >= 0
            else if ('all' in pp)
              return pp.all.indexOf(this.whoami()) >= 0
            else
              return false;
          }
        };

        this.permissions = function(a,b) {
          var ele = b.originalTarget.dataset;
          var payload = {};
          switch(ele.type) {
            case 'root_perms':
              payload['permission'] = ele.arg;
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'root_cmd':
              payload[ele.type] = ele.arg;
              payload['workerpool'] = this.workerpool();
              payload['hostname'] = this.hostname();
              webs.send(JSON.stringify(payload));
              break;
            case 'pool_perms':
              payload['permission'] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'pool_cmd':
              payload[ele.type] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              webs.send(JSON.stringify(payload));
              break;
            case 'server_perms':
              payload['permission'] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'server_cmd':
              payload[ele.type] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              if (ele.supplement)
                payload = Object.assign({}, payload, JSON.parse(ele.supplement))
              webs.send(JSON.stringify(payload));
              break;
            default:
              break;
          }
        }
    }

    window.onload = function(){
      (function(){

        // Activates knockout.js
        var app = new AppViewModel();
        ko.applyBindings(app);

        var ws       = new WebSocket('ws://' + window.location.host + window.location.pathname);
        ws.onopen    = function()  { console.log('websocket opened'); };
        ws.onclose   = function()  { console.log('websocket closed'); }
        ws.onmessage = function(m) { 
          var inbound = JSON.parse(m.data);
          console.log(inbound)
          if ('permissions' in inbound) {
            var p = inbound['permissions']
            app.perms(JSON.parse(p));
          } else if ('msg' in inbound && 'server_name' in inbound) {
            app.server_console.push("{0}: {1}".format(inbound['server_name'], inbound['msg']))
          }
        };
        webs = ws;

      })();
    }

  </script>
</html>
