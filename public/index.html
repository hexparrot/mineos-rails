<html>
  <head>
    <script type='text/javascript' src='https://knockoutjs.com/downloads/knockout-3.5.1.debug.js'></script>
  </head>
  <body>
      <p>Logged in as: <b data-bind="text: whoami"></b></p>
      <p>Show available permissions for</p>
      <select data-bind="options: registered_entities, value: fqdn"></select>
      <p>Affected user</p>
      <input type="text" id="affected_user" data-bind="value: affected_user" />
      <input type="text" data-bind="value: hostname" />
      <h2>root abilities</h2>
      <button type="button" data-bind="click: permissions" data-type="root_perms" data-arg="grantall">grant root abilities (mkpool/rmpool/spawnpool)</button>
      <button type="button" data-bind="click: permissions" data-type="root_perms" data-arg="revokeall">revoke root abilities</button>
      <hr>
      <input type="text" id="workerpool" data-bind="value: workerpool" />
      <button type="button" data-bind="enable: has_permission('root', 'mkpool'), click: permissions" data-type="root_cmd" data-arg="mkpool">mkpool</button>
      <button type="button" data-bind="enable: has_permission('root', 'rmpool'), click: permissions" data-type="root_cmd" data-arg="rmpool">rmpool</button>
      <button type="button" data-bind="enable: has_permission('root', 'spawnpool'), click: permissions" data-type="root_cmd" data-arg="spawnpool">spawnpool</button>
      <hr>
       <h2>pool abilities</h2>
       <button type="button" data-bind="click: permissions" data-type="pool_perms" data-arg="grantall">grant pool abilities: create/delete</button>
       <button type="button" data-bind="click: permissions" data-type="pool_perms" data-arg="revokeall">revoke pool abilities</button>
       <br>
       <br>
       <input type="text" data-bind="value: server_name" />
       <button type="button" data-bind="enable: has_permission('pool', 'create'), click: permissions" data-type="pool_cmd" data-arg="create">create server</button>
       <button type="button" data-bind="enable: has_permission('pool', 'delete'), click: permissions" data-type="pool_cmd" data-arg="delete">delete server</button>
       <hr>
       <h2>server abilities</h2>
       <button type="button" data-bind="click: permissions" data-type="server_perms" data-arg="grantall">grant server abilities: start/stop/etc</button>
       <button type="button" data-bind="click: permissions" data-type="server_perms" data-arg="revokeall">revoke server abilities</button>
       <br>
       <br>
       <button type="button" data-bind="enable: has_permission('server', 'modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "java_xmx", "value": 512}'>xmx</button>
       <button type="button" data-bind="enable: has_permission('server', 'modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "java_xms", "value": 512}'>xms</button>
       <button type="button" data-bind="enable: has_permission('server', 'modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "jarfile", "value": "minecraft_server.1.8.9.jar"}'>jarfile</button>
       <button type="button" data-bind="enable: has_permission('server', 'accept_eula'), click: permissions" data-type="server_cmd" data-arg="accept_eula">eula</button>
       <button type="button" data-bind="enable: has_permission('server', 'receive_profile'), click: permissions" data-type="server_cmd" data-arg="receive_profile" data-supplement='{"group": "mojang", "version": "1.8.9"}'>receive</button>
       <br>
       <br>
       <button type="button" data-bind="enable: has_permission('server', 'start'), click: permissions" data-type="server_cmd" data-arg="start">start</button>
       <button type="button" data-bind="enable: has_permission('server', 'stop'), click: permissions" data-type="server_cmd" data-arg="stop">stop</button>
       <button type="button" data-bind="enable: has_permission('server', 'kill'), click: permissions" data-type="server_cmd" data-arg="kill">kill</button>
       <br><br>
       <button type="button" data-bind="enable: has_permission('server', 'create'), click: permissions" data-type="server_cmd" data-arg="create" data-supplement='{"alt_cmd": "create"'>create server</button>
       <button type="button" data-bind="enable: has_permission('server', 'delete'), click: permissions" data-type="server_cmd" data-arg="delete" data-supplement='{"alt_cmd": "delete"'>delete server</button>
       <hr>
    <ol data-bind="foreach: server_console">
      <li data-bind="text: $data"></li>
    </ol>
  </body>

  <script type="text/javascript">


/* prototypes */

    String.prototype.format = String.prototype.f = function() {
      var s = this,
          i = arguments.length;
    
      while (i--) { s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);}
      return s;
    };

    var webs = null;

    function AppViewModel() {
        var self = this;
        this.whoami = ko.observable();
        this.perms = ko.observable();
        this.affected_user = ko.observable('plain:will');

        this.fqdn = ko.observable('');
        this.hostname = ko.computed(function() {
          var split_fqdn = self.fqdn().split('.');
          try {
            if (split_fqdn[0])
              return split_fqdn[0];
          } catch (e) {}
          return null;
        })

        this.workerpool = ko.computed(function() {
          var split_fqdn = self.fqdn().split('.');
          try {
            if (split_fqdn[1])
              return split_fqdn[1];
          } catch (e) {}
          return null;
        })

        this.server_name = ko.observable('test500');
        this.server_console = ko.observableArray();
        this.registered_hosts = ko.observableArray([]);
        this.registered_pools = ko.observableArray([]);

        this.registered_entities = ko.computed(function() {
          var entries = [];
          entries.push('root');
          for (h in self.registered_hosts())
            entries.push(self.registered_hosts()[h])
          for (p in self.registered_pools())
            entries.push(self.registered_pools()[p])
          return entries;
        })

        this.has_permission = function(group, thing) {
          var p = this.perms();
          var aff_user = this.affected_user();
          var fqdn = null;
          if (p) {
            switch(group) {
              case 'root':
                fqdn = "root";
                break;
              case 'pool':
                var split_fqdn = this.fqdn().split('.')
                if (!split_fqdn[1])
                  return false;
                else
                  fqdn = "{0}.{1}".format(split_fqdn[0], split_fqdn[1]);
                break;
              case 'server':
                var split_fqdn = this.fqdn().split('.')
                if (!split_fqdn[1])
                  return false;
                else
                  fqdn = "{0}.{1}.{2}".format(split_fqdn[0], split_fqdn[1], this.server_name());
                break;
              default:
                console.log("invalid group perm requested");
                return false;
            }
            try {
              var pp = p[fqdn]['permissions'];
            } catch (e) {
              return false;
            }

            if (thing in pp)
              if (pp[thing].indexOf(aff_user) >= 0) //separate to ensure if all runs (when false)
                return true;
            if ('all' in pp)
              return pp.all.indexOf(aff_user) >= 0
            return false;
          } else {
            return false;
          }
        }

        this.permissions = function(a,b) {
          var ele = b.originalTarget.dataset;
          var payload = {};
          switch(ele.type) {
            case 'root_perms':
              payload['permission'] = ele.arg;
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'root_cmd':
              payload[ele.type] = ele.arg;
              payload['workerpool'] = this.workerpool();
              payload['hostname'] = this.hostname();
              webs.send(JSON.stringify(payload));
              break;
            case 'pool_perms':
              payload['permission'] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'pool_cmd':
              payload[ele.type] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              webs.send(JSON.stringify(payload));
              break;
            case 'server_perms':
              payload['permission'] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'server_cmd':
              payload[ele.type] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              if (ele.supplement)
                payload = Object.assign({}, payload, JSON.parse(ele.supplement))
              webs.send(JSON.stringify(payload));
              break;
            default:
              break;
          }
        }
    }

    window.onload = function(){
      (function(){

        // Activates knockout.js
        var app = new AppViewModel();
        ko.applyBindings(app);

        var ws       = new WebSocket('ws://' + window.location.host + window.location.pathname);
        ws.onopen    = function()  { console.log('websocket opened'); };
        ws.onclose   = function()  { console.log('websocket closed'); }
        ws.onmessage = function(m) { 
          var inbound = JSON.parse(m.data);
          //console.log(inbound)
          if ('permissions' in inbound) {
            var p = inbound['permissions']
            app.perms(JSON.parse(p));
            console.log(app.perms())
          } else if ('whoami' in inbound) {
            app.whoami(inbound['whoami']);
          } else if ('msg' in inbound && 'server_name' in inbound) {
            app.server_console.push("{0}: {1}".format(inbound['server_name'], inbound['msg']));
          } else if ('workers' in inbound) {
            for (i in inbound['workers']) {
              var text = inbound['workers'][i];
              var a = text.split('.')
              if (app.registered_hosts().indexOf(a[0]) < 0) //if absent
                app.registered_hosts.push(a[0]);
              if (app.registered_pools().indexOf(text) < 0) //if absent
                app.registered_pools.push(text);
            }
            //app.registered_workers(inbound['workers']);
          }
        };
        webs = ws;

      })();
    }

  </script>
</html>
