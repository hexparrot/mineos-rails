<html>
  <head>
    <script type='text/javascript' src='https://knockoutjs.com/downloads/knockout-3.5.1.debug.js'></script>
  </head>
  <body>
      <p>Logged in as: <b data-bind="text: whoami"></b></p>
      <p>Show available permissions for</p>
      <select data-bind="options: opts, optionsText: 'fqdn', optionsValue: 'fqdn', value: selected"></select>
      <select data-bind="options: managers, value: hostname"></select>
      <p>Affected user</p>
      <input type="text" id="affected_user" data-bind="value: affected_user" />
      <input type="text" data-bind="value: selected" />
      <h2>hostname</h2>
      <h2>root abilities</h2>
      <p data-bind="text: hostname"></p>
      <button type="button" data-bind="enable: can_grant('root', 'grantall'), click: permissions" data-type="root_perms" data-arg="grantall">grant root abilities (mkpool/rmpool/spawnpool)</button>
      <button type="button" data-bind="click: permissions" data-type="root_perms" data-arg="revokeall">revoke root abilities</button>
      <hr>
      <input type="text" id="workerpool" data-bind="value: new_workerpool" />
      <button type="button" data-bind="enable: has_permission('root', 'mkpool'), click: permissions" data-type="root_cmd" data-arg="mkpool">mkpool</button>
      <button type="button" data-bind="enable: has_permission('root', 'rmpool'), click: permissions" data-type="root_cmd" data-arg="rmpool">rmpool</button>
      <button type="button" data-bind="enable: has_permission('root', 'spawnpool'), click: permissions" data-type="root_cmd" data-arg="spawnpool">spawnpool</button>
      <hr>
       <h2>pool abilities</h2>
      <p data-bind="text: workerpool"></p>
       <button type="button" data-bind="click: permissions" data-type="pool_perms" data-arg="grantall">grant pool abilities: create/delete</button>
       <button type="button" data-bind="click: permissions" data-type="pool_perms" data-arg="revokeall">revoke pool abilities</button>
       <br>
       <br>
       <input type="text" data-bind="value: new_server_name" />
       <button type="button" data-bind="enable: has_permission('pool', 'create'), click: permissions" data-type="pool_cmd" data-arg="create">create server</button>
       <button type="button" data-bind="enable: has_permission('pool', 'delete'), click: permissions" data-type="pool_cmd" data-arg="delete">delete server</button>
       <hr>
       <h2>server abilities</h2>
       <p data-bind="text: server_name"></p>
       <button type="button" data-bind="click: permissions" data-type="server_perms" data-arg="grantall">grant server abilities: start/stop/etc</button>
       <button type="button" data-bind="click: permissions" data-type="server_perms" data-arg="revokeall">revoke server abilities</button>
       <br>
       <br>
       <button type="button" data-bind="enable: has_permission('server', 'modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "java_xmx", "value": 512}'>xmx</button>
       <button type="button" data-bind="enable: has_permission('server', 'modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "java_xms", "value": 512}'>xms</button>
       <button type="button" data-bind="enable: has_permission('server', 'modify_sc'), click: permissions" data-type="server_cmd" data-arg="modify_sc" data-supplement='{"section": "java", "attr": "jarfile", "value": "minecraft_server.1.8.9.jar"}'>jarfile</button>
       <button type="button" data-bind="enable: has_permission('server', 'accept_eula'), click: permissions" data-type="server_cmd" data-arg="accept_eula">eula</button>
       <button type="button" data-bind="enable: has_permission('server', 'receive_profile'), click: permissions" data-type="server_cmd" data-arg="receive_profile" data-supplement='{"group": "mojang", "version": "1.8.9"}'>receive</button>
       <br>
       <br>
       <button type="button" data-bind="enable: has_permission('server', 'start'), click: permissions" data-type="server_cmd" data-arg="start">start</button>
       <button type="button" data-bind="enable: has_permission('server', 'stop'), click: permissions" data-type="server_cmd" data-arg="stop">stop</button>
       <button type="button" data-bind="enable: has_permission('server', 'kill'), click: permissions" data-type="server_cmd" data-arg="kill">kill</button>
       <br><br>
       <button type="button" data-bind="enable: has_permission('server', 'create'), click: permissions" data-type="server_cmd" data-arg="create" data-supplement='{"alt_cmd": "create"'>create server</button>
       <button type="button" data-bind="enable: has_permission('server', 'delete'), click: permissions" data-type="server_cmd" data-arg="delete" data-supplement='{"alt_cmd": "delete"'>delete server</button>
       <hr>
    <ol data-bind="foreach: server_console">
      <li data-bind="text: $data"></li>
    </ol>
  </body>

  <script type="text/javascript">


/* prototypes */

    String.prototype.format = String.prototype.f = function() {
      var s = this,
          i = arguments.length;
    
      while (i--) { s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);}
      return s;
    };

    var webs = null;

    function AppViewModel() {
        var self = this;
        this.whoami = ko.observable();
        this.perms = ko.observable({});
        this.affected_user = ko.observable('plain:mc');

        this.server_console = ko.observableArray();

        this.can_grant = function(group, thing) {
          var p = this.perms();
          var me = this.whoami();
          var fqdn = null;

          if (p) {
            switch(group) {
              case 'root':
                fqdn = "root";
                break;
              case 'pool':
                fqdn = (self.workerpool() ? self.selected() : false)
                break;
              case 'server':
                fqdn = (self.server_name() ? self.selected() : false)
                break;
              default:
                console.log("invalid group perm requested");
                return false;
            }
            try {
              var pp = p[fqdn]['properties'];
            } catch (e) {
              return false;
            }

            if (me == pp.owner)
              return true;
            else if (pp.grantors.indexOf(me) >= 0)
              return true;
            return false;
          }
        }

        this.has_permission = function(group, thing) {
          var p = this.perms();
          var aff_user = this.affected_user();
          var fqdn = null;
          if (p) {
            switch(group) {
              case 'root':
                fqdn = "root";
                break;
              case 'pool':
                fqdn = (self.workerpool() ? self.selected() : false)
                break;
              case 'server':
                fqdn = (self.server_name() ? self.selected() : false)
                break;
              default:
                console.log("invalid group perm requested");
                return false;
            }
            try {
              var pp = p[fqdn]['permissions'];
            } catch (e) {
              return false;
            }

            if (thing in pp)
              if (pp[thing].indexOf(aff_user) >= 0) //separate to ensure if all runs (when false)
                return true;
            if ('all' in pp)
              return pp.all.indexOf(aff_user) >= 0
            return false;
          } else {
            return false;
          }
        }

        this.split_fqdn = function(fqdn) {
          try {
            var components = fqdn.split(/\./).filter(function(e) { return e.length > 0 });
          } catch (e) {
            return {}
          }

          switch(components.length) {
            case 1:
              return {fqdn: fqdn, hostname: components[0], workerpool: '', server_name: ''};
              break;
            case 2: 
              return {fqdn: fqdn, hostname: components[0], workerpool: components[1], server_name: ''};
              break;
            case 3: 
              return {fqdn: fqdn, hostname: components[0], workerpool: components[1], server_name: components[2]};
              break;
          }
        }

        this.managers = ko.observableArray();
        this.selected = ko.observable();
        this.hostname = ko.observable();
        this.workerpool = ko.computed(function() { return self.split_fqdn(self.selected())['workerpool'] })
        this.server_name = ko.computed(function() { return self.split_fqdn(self.selected())['server_name'] })
        this.new_workerpool = ko.observable('');
        this.new_server_name = ko.observable('');

        this.opts = ko.computed(function() {
          var opts = [];
          var json = self.perms();
          for (var key in json) {
            if (json.hasOwnProperty(key)) {
              opts.push(self.split_fqdn(key));
            }
          }
          return opts;
        });

        this.permissions = function(a,b) {
          var ele = b.originalTarget.dataset;
          var payload = {};
          switch(ele.type) {
            case 'root_perms':
              payload['permission'] = ele.arg;
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'root_cmd':
              payload[ele.type] = ele.arg;
              payload['workerpool'] = this.new_workerpool();
              payload['hostname'] = this.hostname();
              webs.send(JSON.stringify(payload));
              break;
            case 'pool_perms':
              payload['permission'] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'pool_cmd':
              payload[ele.type] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.new_workerpool();
              payload['server_name'] = this.new_server_name();
              webs.send(JSON.stringify(payload));
              break;
            case 'server_perms':
              payload['permission'] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.workerpool();
              payload['server_name'] = this.server_name();
              payload['affected_user'] = this.affected_user();
              webs.send(JSON.stringify(payload));
              break;
            case 'server_cmd':
              payload[ele.type] = ele.arg;
              payload['hostname'] = this.hostname();
              payload['workerpool'] = this.new_workerpool();
              payload['server_name'] = this.new_server_name();
              if (ele.supplement)
                payload = Object.assign({}, payload, JSON.parse(ele.supplement))
              webs.send(JSON.stringify(payload));
              break;
            default:
              break;
          }
        }
    }

    window.onload = function(){
      (function(){

        // Activates knockout.js
        var app = new AppViewModel();
        ko.applyBindings(app);

        var ws       = new WebSocket('ws://' + window.location.host + window.location.pathname);
        ws.onopen    = function()  { console.log('websocket opened'); };
        ws.onclose   = function()  { console.log('websocket closed'); }
        ws.onmessage = function(m) { 
          var inbound = JSON.parse(m.data);
          if ('permissions' in inbound) {
            var p = inbound['permissions']
            app.perms(JSON.parse(p));
          } else if ('whoami' in inbound) {
            app.whoami(inbound['whoami']);
          } else if ('msg' in inbound && 'server_name' in inbound) {
            app.server_console.push("{0}: {1}".format(inbound['server_name'], inbound['msg']));
          } else if ('managers' in inbound) {
            for (m in inbound['managers']) {
              var worker = inbound['managers'][m].substring(inbound['managers'][m].indexOf('.')+1)
              if (app.managers.indexOf(worker) < 0)
                app.managers.push(worker.substring(worker.indexOf('.')+1));
            }
          } else {
            console.log(inbound)
            
          }
        };
        webs = ws;

      })();
    }

  </script>
</html>
